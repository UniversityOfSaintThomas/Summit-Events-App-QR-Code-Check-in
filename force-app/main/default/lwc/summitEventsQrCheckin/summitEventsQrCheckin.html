<template>
    <lightning-card title={title} icon-name="standard:event">
        <div class="slds-card__body slds-card__body_inner">

            <!-- Session Not Started View -->
            <template if:true={showSessionControls}>
                <div class="slds-text-align_center slds-m-vertical_large">
                    <lightning-icon icon-name="utility:scan" size="large" class="slds-m-bottom_medium"></lightning-icon>
                    <h2 class="slds-text-heading_medium slds-m-bottom_small">Ready to Check In Registrants</h2>

                    <!-- Show different message based on context -->
                    <template if:true={isOnInstanceRecordPage}>
                        <p class="slds-text-body_regular slds-m-bottom_medium">
                            Click "Start Scanning Session" to begin checking in attendees for this event instance.
                        </p>
                    </template>
                    <template if:false={isOnInstanceRecordPage}>
                        <p class="slds-text-body_regular slds-m-bottom_medium">
                            Select the event date and instance to begin checking in attendees.
                        </p>
                    </template>

                    <!-- Event Selection Form (only show when NOT on instance record page) -->
                    <template if:true={showDateInstanceSelection}>
                        <div class="slds-text-align_center">
                            <div class="slds-m-bottom_medium">
                                <lightning-input
                                        type="date"
                                        label="Event Instance Date"
                                        value={selectedDate}
                                        onchange={handleDateChange}
                                        required
                                ></lightning-input>
                            </div>

                            <template if:true={loadingInstances}>
                                <div class="slds-text-align_center slds-m-vertical_medium">
                                    <lightning-spinner alternative-text="Loading instances..." size="small"></lightning-spinner>
                                    <p class="slds-m-top_small slds-text-body_small">Loading event instances...</p>
                                </div>
                            </template>

                            <template if:true={showInstancePicker}>
                                <div class="slds-m-bottom_medium">
                                    <lightning-combobox
                                            label="Event Instance"
                                            value={selectedInstanceId}
                                            placeholder="Select an event instance"
                                            options={instanceOptions}
                                            onchange={handleInstanceChange}
                                            required
                                    ></lightning-combobox>
                                </div>
                            </template>

                            <template if:true={noInstancesFound}>
                                <div class="slds-m-bottom_medium">
                                    <div class="slds-notify slds-notify_alert slds-alert_warning" role="alert">
                                        <span class="slds-assistive-text">warning</span>
                                        <lightning-icon icon-name="utility:warning" size="x-small" variant="warning" class="slds-m-right_x-small"></lightning-icon>
                                        <h2>No event instances found for the selected date.</h2>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <lightning-button
                            label="Start Scanning Session"
                            variant="brand"
                            onclick={handleStartSession}
                            icon-name="utility:play"
                            class="session-start-button"
                            disabled={isStartButtonDisabled}
                    ></lightning-button>
                </div>
            </template>

            <!-- Active Session View -->
            <template if:true={showActiveSessionControls}>
                <!-- Selected Event and Instance Display with Counters -->
                <div class="slds-m-bottom_medium">
                    <!-- Event/Instance Header with Link -->
                    <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_small slds-border_bottom">
                        <div class="slds-col">
                            <div class="slds-text-heading_regular">
                                {selectedEventName}
                            </div>
                            <div class="slds-text-body_regular slds-m-bottom_xx-small">
                                {selectedInstanceName}
                            </div>
                            <template if:true={selectedInstanceStartDate}>
                                <div class="slds-text-body_regular">
                                    <lightning-icon icon-name="utility:date_time" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
                                    <lightning-formatted-date-time
                                            value={selectedInstanceStartDate}
                                            year="numeric"
                                            month="short"
                                            day="numeric"
                                    >
                                    </lightning-formatted-date-time>
                                    <template if:true={formattedInstanceTime}>
                                        &nbsp;at {formattedInstanceTime}
                                    </template>
                                </div>
                            </template>
                            <a href={selectedInstanceUrl} target="_blank" rel="noopener noreferrer" class="slds-button slds-button_neutral slds-button_small slds-m-top_x-small slds-m-bottom_small">
                                <lightning-icon icon-name="utility:new_window" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
                                View Instance
                            </a>
                        </div>
                    </div>

                    <!-- Session Counters Inside Panel (Refactored) -->
                    <div class="slds-grid slds-gutters slds-m-top_small slds-text-align_center counter-grid">
                        <!-- Session Count -->
                        <div class="slds-col slds-size_1-of-2">
                            <div class="slds-box slds-box_xx-small slds-theme_default counter-box">
                                <div class="counter-icon">
                                    <lightning-icon icon-name="utility:clock" size="small" class="white-icon" alternative-text="Session scans"></lightning-icon>
                                </div>
                                <div class="counter-metrics">
                                    <div class="counter-number">{scanCount}</div>
                                    <div class="counter-label">This Session</div>
                                </div>
                            </div>
                        </div>
                        <!-- Attended / Registered Combined -->
                        <div class="slds-col slds-size_1-of-2">
                            <div class="slds-box slds-box_xx-small slds-theme_success counter-box">
                                <div class="counter-icon">
                                    <lightning-icon icon-name="utility:success" size="small" class="white-icon" alternative-text="Attendance"></lightning-icon>
                                </div>
                                <div class="counter-metrics">
                                    <div class="counter-number">{attendanceProgress}</div>
                                    <div class="counter-label">Attended / Registered</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Check-In Options -->
                <div class="slds-m-bottom_medium slds-text-align_center">
                    <!-- Camera Scan Button (only show when camera is not active) -->
                    <template if:false={showCameraScanner}>
                        <div class="slds-m-bottom_xx-small slds-text-align_center">
                            <lightning-button
                                    label="Scan with Camera"
                                    variant="brand"
                                    icon-name="utility:photo"
                                    onclick={handleBrowserCameraScan}
                                    disabled={isProcessing}
                                    class="slds-size_1-of-1"
                            ></lightning-button>
                        </div>
                    </template>

                    <!-- Inline Camera Scanner (shows when scanning is active) -->
                    <template if:true={showCameraScanner}>
                        <div class="slds-m-bottom_medium">
                            <div class="inline-camera-header slds-m-bottom_small">
                                <h3 class="slds-text-heading_small slds-m-bottom_x-small">
                                    <lightning-icon icon-name="utility:photo" size="x-small" class="slds-m-right_xx-small"></lightning-icon>
                                    Scan QR Code
                                </h3>
                                <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_x-small">
                                    Position the QR code in front of the camera
                                </p>
                            </div>
                            <div class="inline-camera-container">
                                <video lwc:ref="videoElement" autoplay playsinline class="camera-video"></video>
                                <canvas lwc:ref="canvasElement" class="camera-canvas"></canvas>
                            </div>
                            <div class="slds-m-top_small slds-text-align_center">
                                <lightning-button
                                        label="Cancel Scanning"
                                        variant="neutral"
                                        icon-name="utility:close"
                                        onclick={handleCloseCameraScanner}
                                ></lightning-button>
                            </div>
                        </div>
                    </template>

                    <!-- Or Divider -->
                    <div class="slds-text-align_center slds-m-vertical_xx-small">
                        <span class="slds-text-body_small slds-text-color_weak">OR</span>
                    </div>

                    <!-- Inline Manual Lookup -->
                    <div class="slds-m-bottom_small">
                        <h3 class="slds-text-heading_small">
                            <lightning-icon icon-name="utility:search" size="x-small" class="slds-m-right_xx-small"></lightning-icon>
                            Search by Name
                        </h3>

                        <!-- Search Inputs -->
                        <div class="slds-grid slds-gutters slds-wrap slds-m-bottom_x-small slds-text-align_left">
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 ">
                                <lightning-input
                                        label="First Name"
                                        value={firstName}
                                        onchange={handleFirstNameChange}
                                        placeholder="Enter first name..."
                                        disabled={isProcessing}
                                ></lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 ">
                                <lightning-input
                                        label="Last Name"
                                        value={lastName}
                                        onchange={handleLastNameChange}
                                        placeholder="Enter last name..."
                                        disabled={isProcessing}
                                ></lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-1">
                                <lightning-input
                                        label="Email"
                                        type="email"
                                        value={email}
                                        onchange={handleEmailChange}
                                        placeholder="Enter email..."
                                        disabled={isProcessing}
                                ></lightning-input>
                            </div>
                        </div>

                        <!-- Search Button -->
                        <lightning-button
                                label="Search"
                                variant="neutral"
                                icon-name="utility:search"
                                onclick={handleSearchRegistrations}
                                disabled={isSearchingOrProcessing}
                                class="slds-size_1-of-1"
                        ></lightning-button>

                        <!-- Searching Spinner -->
                        <template if:true={isSearching}>
                            <div class="slds-text-align_center slds-m-vertical_small">
                                <lightning-spinner alternative-text="Searching..." size="small"></lightning-spinner>
                                <p class="slds-m-top_x-small slds-text-body_small">Searching registrations...</p>
                            </div>
                        </template>

                        <!-- Pending Check-In Card (Registration Found - Awaiting Confirmation) -->
                        <template if:true={hasPendingCheckin}>
                            <div lwc:ref="resultsSection" class="slds-box slds-theme_default slds-m-bottom_medium slds-m-top_medium">
                                <div class="slds-grid slds-grid_vertical-align-left slds-m-bottom_small">
                                    <div class="slds-col slds-size_1-of-12">
                                        <lightning-icon
                                                icon-name="utility:user"
                                                size="medium"
                                        ></lightning-icon>
                                    </div>
                                    <div class="slds-col slds-size_11-of-12 slds-text-align_left">
                                        <div class="slds-text-heading_small slds-text-color_success slds-m-bottom_x-small">
                                            Registration Found
                                        </div>
                                        <div class="slds-text-body_regular slds-m-bottom_xx-small">
                                            <strong>Name: </strong> {pendingCheckin.registrantName}
                                        </div>
                                        <div class="slds-text-body_small slds-m-bottom_xx-small">
                                            <strong>Event: </strong> {pendingCheckin.eventName}
                                        </div>
                                        <template if:true={pendingCheckin.instanceTitle}>
                                            <div class="slds-text-body_small slds-m-bottom_xx-small">
                                                <strong>Instance: </strong> {pendingCheckin.instanceTitle}
                                            </div>
                                        </template>
                                        <template if:true={pendingCheckin.instanceStartDate}>
                                            <div class="slds-text-body_small slds-m-bottom_xx-small">
                                                <strong>Event Date: </strong>
                                                <lightning-formatted-date-time value={pendingCheckin.instanceStartDate} year="numeric" month="short" day="numeric"></lightning-formatted-date-time>
                                                <template if:true={formattedEventTime}>
                                                    at {formattedEventTime}
                                                </template>
                                            </div>
                                        </template>
                                        <div class="slds-text-body_small slds-m-bottom_xx-small">
                                            <a href={registrationRecordUrl} target="_blank" rel="noopener noreferrer">
                                                View Registration Record
                                                <lightning-icon icon-name="utility:new_window" size="xx-small" class="slds-m-left_xx-small"></lightning-icon>
                                            </a>
                                        </div>
                                        <template if:true={pendingCheckin.alreadyCheckedIn}>
                                            <div class="slds-m-top_small">
                                                <span class="slds-badge slds-theme_warning">
                                                    <lightning-icon icon-name="utility:warning" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
                                                    Already Checked In
                                                </span>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Check-In Actions -->
                                <template if:false={pendingCheckin.alreadyCheckedIn}>
                                    <div class="slds-grid slds-gutters slds-m-top_medium">
                                        <div class="slds-col slds-size_1-of-2">
                                            <lightning-button
                                                    label="Cancel"
                                                    variant="neutral"
                                                    onclick={handleCancelCheckIn}
                                                    class="slds-size_1-of-1"
                                            ></lightning-button>
                                        </div>
                                        <div class="slds-col slds-size_1-of-2">
                                            <lightning-button
                                                    label="Check In"
                                                    variant="brand"
                                                    icon-name="utility:check"
                                                    onclick={handleConfirmCheckIn}
                                                    disabled={isProcessing}
                                                    class="slds-size_1-of-1"
                                            ></lightning-button>
                                        </div>
                                    </div>
                                </template>

                                <!-- If already checked in, show undo and close buttons -->
                                <template if:true={pendingCheckin.alreadyCheckedIn}>
                                    <div class="slds-grid slds-gutters slds-m-top_medium">
                                        <div class="slds-col slds-size_1-of-2">
                                            <lightning-button
                                                    label="Close"
                                                    variant="neutral"
                                                    onclick={handleCancelCheckIn}
                                                    class="slds-size_1-of-1"
                                            ></lightning-button>
                                        </div>
                                        <div class="slds-col slds-size_1-of-2">
                                            <lightning-button
                                                    label="Undo Check-In"
                                                    variant="destructive"
                                                    icon-name="utility:undo"
                                                    onclick={handleUndoCheckIn}
                                                    disabled={isProcessing}
                                                    class="slds-size_1-of-1"
                                            ></lightning-button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Search Results -->
                        <template if:true={hasSearchResults}>
                            <div class="slds-m-top_medium">
                                <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
                                    <div class="slds-col">
                                        <div class="slds-text-heading_small">
                                            Results
                                        </div>
                                    </div>
                                    <div class="slds-col">
                                        <div class="slds-text-body_small slds-text-color_weak">
                                            {pageInfo}
                                        </div>
                                    </div>
                                </div>

                                <div class="search-results-container">
                                    <template for:each={paginatedResults} for:item="registration">
                                        <div key={registration.registrationId}
                                             data-id={registration.registrationId}
                                             onclick={handleSelectRegistration}
                                             class="slds-box slds-box_x-small slds-m-bottom_x-small"
                                             style="cursor: pointer;">
                                            <div class="slds-grid slds-grid_vertical-align-top slds-text-align_left slds-text-color_default">
                                                <div class="slds-col slds-has-flexi-truncate">
                                                    <div class="slds-text-body_regular slds-text-heading_small">
                                                        {registration.registrantName}
                                                    </div>
                                                    <div class="slds-text-body_small slds-text-color_weak">
                                                        {registration.eventName}
                                                        <template if:true={registration.instanceTitle}>
                                                            - {registration.instanceTitle}
                                                        </template>
                                                    </div>
                                                    <template if:true={registration.email}>
                                                        <div class="slds-text-body_small slds-text-color_weak">
                                                            {registration.email}
                                                        </div>
                                                    </template>
                                                </div>
                                                <div class="slds-col slds-no-flex">
                                                    <template if:true={registration.isCheckedIn}>
                                                        <span class="slds-badge slds-theme_success">
                                                            <lightning-icon icon-name="utility:check" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
                                                            Checked In
                                                        </span>
                                                    </template>
                                                    <template if:false={registration.isCheckedIn}>
                                                        <span class="slds-badge">
                                                            <lightning-icon icon-name="utility:steps" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
                                                            {registration.status}
                                                        </span>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <!-- Pagination Controls -->
                                <template if:true={showPagination}>
                                    <div class="slds-m-top_small">
                                        <div class="slds-grid slds-grid_align-space slds-grid_vertical-align-center">
                                            <div class="slds-col">
                                                <lightning-button
                                                        label="Previous"
                                                        icon-name="utility:chevronleft"
                                                        onclick={handlePreviousPage}
                                                        disabled={isOnFirstPage}
                                                        variant="neutral"
                                                ></lightning-button>
                                            </div>
                                            <div class="slds-col slds-text-align_center">
                                                <span class="slds-text-body_small">
                                                    Page {currentPage} of {totalPages}
                                                </span>
                                            </div>
                                            <div class="slds-col slds-text-align_right">
                                                <lightning-button
                                                        label="Next"
                                                        icon-name="utility:chevronright"
                                                        icon-position="right"
                                                        onclick={handleNextPage}
                                                        disabled={isOnLastPage}
                                                        variant="neutral"
                                                ></lightning-button>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- No Results Message -->
                        <template if:true={showNoResults}>
                            <div class="slds-m-top_medium">
                                <div class="slds-notify slds-notify_alert slds-alert_warning" role="alert">
                                    <span class="slds-assistive-text">warning</span>
                                    <lightning-icon icon-name="utility:warning" size="x-small" variant="warning" class="slds-m-right_x-small"></lightning-icon>
                                    <h2>No registrations found matching your search.</h2>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Processing Spinner -->
                <template if:true={isProcessing}>
                    <div class="slds-m-vertical_medium slds-text-align_center">
                        <lightning-spinner alternative-text="Processing..." size="small"></lightning-spinner>
                        <p class="slds-m-top_small">Processing check-in...</p>
                    </div>
                </template>

                <!-- Success Result Card (After Check-In Confirmed) -->
                <template if:true={hasCompletedCheckin}>
                    <div class={resultCardClass}>
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <div class="slds-col slds-size_1-of-12">
                                <lightning-icon
                                        icon-name="utility:success"
                                        size="medium"
                                        variant="success"
                                ></lightning-icon>
                            </div>
                            <div class="slds-col slds-size_11-of-12">
                                <div class="slds-text-heading_small slds-m-bottom_x-small">
                                    {lastCheckinResult.message}
                                </div>
                                <template if:true={lastCheckinResult.registrantName}>
                                    <div class="slds-text-body_regular">
                                        <strong>Name:</strong> {lastCheckinResult.registrantName}
                                    </div>
                                </template>
                                <template if:true={lastCheckinResult.eventName}>
                                    <div class="slds-text-body_small">
                                        <strong>Event:</strong> {lastCheckinResult.eventName}
                                    </div>
                                </template>
                                <template if:true={lastCheckinResult.instanceTitle}>
                                    <div class="slds-text-body_small">
                                        <strong>Instance:</strong> {lastCheckinResult.instanceTitle}
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

            </template>
        </div>

        <!-- Footer with Session Status Bar and Actions (only show when session is active) -->
        <template if:true={showActiveSessionControls}>
            <div slot="footer">
                <!-- Session Status -->
                <div class="slds-size_1-of-1 slds-text-align_center">
                            <span class="status-indicator">
                                <span class="status-dot active"></span>
                                <span class="slds-text-body_small">Session Active</span>
                            </span>
                    <span class="slds-text-body_small slds-text-color_weak slds-m-left_medium">
                                Duration: {sessionDuration}
                            </span>
                </div>
                <!-- Action Buttons -->
                <div class="slds-size_1-of-1 slds-m-top_small slds-text-align_center">
                    <lightning-button
                            label="Reset Counter"
                            icon-name="utility:refresh"
                            onclick={handleResetSession}
                            variant="neutral"
                            class="slds-m-right_x-small"
                    ></lightning-button>
                    <lightning-button
                            label="End Session"
                            icon-name="utility:stop"
                            onclick={handleStopSession}
                            variant="destructive"
                    ></lightning-button>
                </div>
            </div>
        </template>
    </lightning-card>
</template>
